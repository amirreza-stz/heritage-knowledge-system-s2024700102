@prefix : <http://www.semanticweb.org/ubuntu/ontologies/2026/0/s2024700102heritage/> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

# ============================================
# SHACL Validation Shapes for Cultural Heritage Ontology
# ============================================

:ValidationShape rdf:type sh:NodeShape ;
                 sh:targetClass :Person ;
                 sh:property [
                     sh:path :hasAccessLevel ;
                     sh:datatype xsd:integer ;
                     sh:minInclusive 1 ;
                     sh:maxInclusive 3 ;
                     sh:message "Access level must be between 1 and 3"@en
                 ] ;
                 sh:property [
                     sh:path :humanApproval ;
                     sh:datatype xsd:boolean ;
                     sh:message "Human approval must be a boolean value"@en
                 ] .

# Recording validation
:RecordingShape rdf:type sh:NodeShape ;
                sh:targetClass :Recording ;
                sh:property [
                    sh:path :recordingDate ;
                    sh:datatype xsd:date ;
                    sh:minCount 1 ;
                    sh:message "Recording must have a recording date"@en
                ] ;
                sh:property [
                    sh:path :performedBy ;
                    sh:minCount 1 ;
                    sh:message "Recording must have at least one performer"@en
                ] ;
                sh:property [
                    sh:path :recordedAt ;
                    sh:minCount 1 ;
                    sh:message "Recording must have a location"@en
                ] .

# Cultural Item validation
:CulturalItemShape rdf:type sh:NodeShape ;
                   sh:targetClass :CulturalItem ;
                   sh:property [
                       sh:path :requiresAccessLevel ;
                       sh:datatype xsd:integer ;
                       sh:minInclusive 1 ;
                       sh:maxInclusive 3 ;
                       sh:message "Access level must be between 1 and 3"@en
                   ] ;
                   sh:property [
                       sh:path :locatedIn ;
                       sh:minCount 1 ;
                       sh:message "Cultural item must have a location"@en
                   ] .

# Person with role validation
:PersonWithRoleShape rdf:type sh:NodeShape ;
                     sh:targetClass :Person ;
                     sh:property [
                         sh:path :hasRole ;
                         sh:minCount 1 ;
                         sh:message "Person should have at least one role"@en
                     ] .

# Sacred Item validation - must have guardian
# Note: Data uses caresFor (Person -> SacredItem), so we validate via inverse path
:SacredItemShape rdf:type sh:NodeShape ;
                 sh:targetClass :SacredItem ;
                 sh:property [
                     sh:path [ sh:inversePath :caresFor ] ;
                     sh:minCount 1 ;
                     sh:message "Sacred item must have at least one guardian (via caresFor)"@en
                 ] ;
                 sh:property [
                     sh:path :requiresAccessLevel ;
                     sh:datatype xsd:integer ;
                     sh:minInclusive 2 ;
                     sh:maxInclusive 3 ;
                     sh:message "Sacred items must require access level 2 or 3"@en
                 ] .

# Tribal Elder validation
:TribalElderShape rdf:type sh:NodeShape ;
                  sh:targetClass :TribalElder ;
                  sh:property [
                      sh:path :hasAccessLevel ;
                      sh:hasValue 3 ;
                      sh:message "Tribal elders must have access level 3"@en
                  ] ;
                  sh:property [
                      sh:path :humanApproval ;
                      sh:hasValue true ;
                      sh:message "Tribal elders must have human approval"@en
                  ] .

# Instrument validation
:InstrumentShape rdf:type sh:NodeShape ;
                 sh:targetClass :Instrument ;
                 sh:property [
                     sh:path :locatedIn ;
                     sh:minCount 1 ;
                     sh:message "Instrument must have a location"@en
                 ] .

# Community member validation
:CommunityMemberShape rdf:type sh:NodeShape ;
                      sh:targetClass :Person ;
                      sh:property [
                          sh:path :memberOfCommunity ;
                          sh:minCount 1 ;
                          sh:message "Person should be a member of at least one community"@en
                      ] .

# Recording access level validation
# Validates that performer access level meets instrument requirements when recording date is after restriction date
:RecordingAccessLevelShape rdf:type sh:NodeShape ;
                           sh:targetClass :Recording ;
                           sh:sparql [
                               sh:message "When recording date is after restriction effective date, performer access level must meet instrument requirements"@en ;
                               sh:select """
                                   SELECT $this ?performer ?instrument ?recordingDate ?restrictionDate ?performerAccess ?itemAccess
                                   WHERE {
                                       $this :performedBy ?performer .
                                       $this :usesInstrument ?instrument .
                                       $this :recordingDate ?recordingDate .
                                       ?instrument :restrictionEffectiveDate ?restrictionDate .
                                       ?instrument :requiresAccessLevel ?itemAccess .
                                       ?performer :hasAccessLevel ?performerAccess .
                                       FILTER (?recordingDate > ?restrictionDate && ?performerAccess < ?itemAccess)
                                   }
                               """
                           ] .

# ============================================
# ADDITIONAL COMPREHENSIVE VALIDATIONS
# ============================================

# Mentor validation - mentor must have higher access level or approval
:MentorshipShape rdf:type sh:NodeShape ;
                 sh:targetClass :Person ;
                 sh:sparql [
                     sh:message "Mentor should have higher or equal access level than mentee, or be a TribalElder"@en ;
                     sh:select """
                         SELECT $this ?mentee ?mentorAccess ?menteeAccess
                         WHERE {
                             $this :mentoredBy ?mentor .
                             $this :hasAccessLevel ?menteeAccess .
                             ?mentor :hasAccessLevel ?mentorAccess .
                             FILTER (?mentorAccess < ?menteeAccess)
                             FILTER NOT EXISTS { ?mentor rdf:type :TribalElder }
                         }
                     """
                 ] .

# Approved person validation - must have humanApproval if approvedBy exists
:ApprovalConsistencyShape rdf:type sh:NodeShape ;
                          sh:targetClass :Person ;
                          sh:sparql [
                              sh:message "Person approved by elder must have humanApproval set to true"@en ;
                              sh:select """
                                  SELECT $this ?elder
                                  WHERE {
                                      $this :approvedBy ?elder .
                                      ?elder rdf:type :TribalElder .
                                      OPTIONAL { $this :humanApproval ?approval }
                                      FILTER (!bound(?approval) || ?approval != true)
                                  }
                              """
                          ] .

# Recording instrument consistency - at least one performer should play each instrument
:RecordingInstrumentShape rdf:type sh:NodeShape ;
                           sh:targetClass :Recording ;
                           sh:sparql [
                               sh:message "At least one performer should play each instrument used in recording"@en ;
                               sh:select """
                                   SELECT $this ?instrument
                                   WHERE {
                                       $this :usesInstrument ?instrument .
                                       FILTER NOT EXISTS {
                                           $this :performedBy ?performer .
                                           ?performer :playsInstrument ?instrument
                                       }
                                   }
                               """
                           ] .

# Access level hierarchy validation
# Level 3 (Sacred/Elder) > Level 2 (Restricted) > Level 1 (Public)
:AccessLevelHierarchyShape rdf:type sh:NodeShape ;
                            sh:targetClass :Person ;
                            sh:sparql [
                                sh:message "Person with access level 3 should be TribalElder or have humanApproval"@en ;
                                sh:select """
                                    SELECT $this ?accessLevel
                                    WHERE {
                                        $this :hasAccessLevel 3 .
                                        FILTER NOT EXISTS { $this rdf:type :TribalElder }
                                        OPTIONAL { $this :humanApproval ?approval }
                                        FILTER (!bound(?approval) || ?approval != true)
                                    }
                                """
                            ] .

# Competency validation - person should have competencies matching their roles
:CompetencyRoleShape rdf:type sh:NodeShape ;
                     sh:targetClass :Person ;
                     sh:sparql [
                         sh:message "Person with AshiqRole should have musical competencies"@en ;
                         sh:select """
                             SELECT $this ?role
                             WHERE {
                                 $this :hasRole ?role .
                                 ?role rdf:type :AshiqRole .
                                 FILTER NOT EXISTS {
                                     $this :hasCompetency ?comp .
                                     ?comp rdf:type :InstrumentSkill
                                 }
                             }
                         """
                     ] .

